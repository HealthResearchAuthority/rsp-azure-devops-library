steps:
  - task: DotNetCoreCLI@2
    inputs:
      command: 'publish'
      arguments: '--configuration Release --output publish_output'
      publishWebProjects: false
      zipAfterPublish: false
      modifyOutputPath: false 
      projects: '**/*.csproj'
      
  - task: ArchiveFiles@2
    displayName: "Archive files"
    inputs:
      rootFolderOrFile: "$(System.DefaultWorkingDirectory)/publish_output"
      includeRootFolder: false
      archiveFile: "$(System.DefaultWorkingDirectory)/build$(Build.BuildId).zip"

  - task: PublishBuildArtifacts@1
    inputs:
      PathtoPublish: '$(System.DefaultWorkingDirectory)/build$(Build.BuildId).zip'
      artifactName: 'drop'

  - task: AzureFunctionApp@2
    displayName: 'Deploy Function App'
    inputs:
      azureSubscription: $(service_connection)
      appType: 'functionApp'
      appName: $(FunctionAppServiceName)
      package: '$(System.ArtifactsDirectory)/**/*.zip'

  - task: AzureAppServiceSettings@1
    displayName: 'Update Function App Settings'
    inputs: 
      azureSubscription: $(service_connection)
      appName: $(AppServiceName)
      appSettings: |
        [
          {
            "name": "AppSettings__RtsApiId", 
            "value": "$(RtsApiId)", 
            "slotSetting": false
          },
          {
            "name": "AppSettings__RtsApiSecret", 
            "value": "$(RtsApiSecret)", 
            "slotSetting": false
          },
          {
            "name": "AppSettings__AzureVaultUri", 
            "value": "$(AzureVaultUri)", 
            "slotSetting": false
          },
          {
            "name": "AppSettings__RtsAuthUrl", 
            "value": "$(RtsAuthUrl)", 
            "slotSetting": false
          },
          {
            "name": "AppSettings__RtsOrgDataUrl", 
            "value": "$(RtsOrgDataUrl)", 
            "slotSetting": false
          },
          {
            "name": "AppSettings__RtsRolesDataUrl", 
            "value": "$(RtsRolesDataUrl)", 
            "slotSetting": false
          },
          {
            "name": "AppSettings__RtsTermsetDataUrl", 
            "value": "$(RtsTermsetDataUrl)", 
            "slotSetting": false
          },
          {
            "name": "AppSettings__RtsApiBaseUrl", 
            "value": "$(RtsApiBaseUrl)", 
            "slotSetting": false
          }
        ]