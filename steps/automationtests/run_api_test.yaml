parameters:
  - name: reportDirectory
  - name: repo

steps:
  - checkout: ${{ parameters.repo }}
  - task: Npm@1
    displayName: 'Install Dependencies'
    inputs:
      command: custom
      verbose: false
      customCommand: 'install newman -g'

  - script: |
      npm install -g newman-reporter-htmlextra jq
    displayName: 'Install Dependency to generate HTML report and jq'

  - script: |
      echo "Content of Test_Data.JSON:"
      cat $(System.DefaultWorkingDirectory)/resources/testdata/Test_Data.json

      JSON_DATA=$(cat $(System.DefaultWorkingDirectory)/resources/testdata/Test_Data.json)
      echo "Content of JSON_DATA variable:"
      echo "$JSON_DATA"

      COLLECTION_PATH=$(System.DefaultWorkingDirectory)/postmancollection/POC_Test_data.postman_collection.json
      echo "Postman collection path: $COLLECTION_PATH"

      if [ -f "$COLLECTION_PATH" ]; then
        echo "Postman collection exists."
      else
        echo "Postman collection does not exists."  
        exit 1
      fi

      echo "Running Newman command..."
      set -x
      newman run "$COLLECTION_PATH" --env-var "requestBody=$JSON_DATA" -r htmlextra --reporter-htmlextra-export $(System.DefaultWorkingDirectory)/${{ parameters.reportDirectory }}/TestResults/API_Test_Report.html
    displayName: 'Run Postman API Tests'

  - task: PublishBuildArtifacts@1
    displayName: Publish API Test Report
    condition: always()
    inputs:
      PathtoPublish: '$(System.DefaultWorkingDirectory)/${{ parameters.reportDirectory }}/TestResults'
      ArtifactName: API_Test_Report
      publishLocation: 'Container'